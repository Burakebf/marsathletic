<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
<head>
    <meta http-equiv="content-type" content="text/html;charset=UTF-8">

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <style>
        body {
            padding-top: 10px;
            padding-bottom: 10px;
        }
    </style>
    <link rel="stylesheet" href="assets/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="assets/css/main.css">

    <link rel="stylesheet" href="assets/css/jquery-ui.css">

    <script src="assets/js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>

    <script src="assets/js/vendor/jquery-1.11.2.min.js"></script>

    <script src="assets/js/vendor/jquery-ui.js"></script>

    <script src="assets/js/vendor/bootstrap.min.js"></script>

    <script src="assets/js/vendor/jquery.validate.js"></script>

    <script src="assets/js/main.js"></script>

    <!-- Dashboard implementation -->
    <script type="text/javascript">
        $(document).ready(function() {

            function FillWorkLocations() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:1874/Rest/Operations/GetWorkLocations",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function(data)
                            {
                                 $.each(data, function (){
                                     $("#workLocations").append($("<option     />").val(this.ExternalID).text(this.Name));
                                });
                            },
                    error: function () {
                        alert("Web servis'e erişilemiyor.");
                    }
                });
            }

            function FillEmployees() {
                $.ajax({
                    type: "GET",
                    url: "http://localhost:1874/Rest/Operations/GetEmployees",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function(data)
                            {
                                 $.each(data, function (){
                                     $("#employees").append($("<option     />").val(this.ExternalID).text(this.Name));
                                });
                            },
                    error: function () {
                        alert("Web servis'e erişilemiyor.");
                    }
                });
            }

            FillWorkLocations();
            FillEmployees();

            $( "#datepicker" ).datepicker();

            var handleFileSelect = function(evt) {
                var files = evt.target.files;
                var file = files[0];



                if (files && file) {
                    var reader = new FileReader();

                    reader.onload = function(readerEvt) {
                        var binaryString = readerEvt.target.result;

                        document.getElementById("documentValue").value = btoa(binaryString);

                        var fileValue = $("#document").val().replace("C:\\fakepath\\", "")


                        $("#documentName").val(fileValue);

                    };

                    reader.readAsBinaryString(file);
                }
            };

            if (window.File && window.FileReader && window.FileList && window.Blob) {
                document.getElementById('document').addEventListener('change', handleFileSelect, false);
            } else {
                alert('The File APIs are not fully supported in this browser.');
            }

            function removeExtension(filename){
                var lastDotPosition = filename.lastIndexOf(".");
                if (lastDotPosition === -1) return filename;
                else return filename.substr(0, lastDotPosition);
            }

            function getExtension(filename) {
                return filename.split('.').pop().toLowerCase();
            }


            $("#createDocument").click(function(e) {
                
                var documentByteArray = $("#documentValue").val();

                if (!$.trim(documentByteArray) == "") 
                {
                    var validator = $( "#form1" ).validate();
                    var validated = validator.form();

                        if (validated) {
                            var documentName = removeExtension($("#documentName").val());

                            var extension = getExtension($("#documentName").val());

                            var dataObject = {};

                                    dataObject.DocumentName= documentName;
                                    dataObject.DocumentExtension = extension;
                                    dataObject.ByteData = documentByteArray;
                                    dataObject.EmployeeId= $("#employees").val();
                                    dataObject.LocationId= $("#workLocations").val();
                                    dataObject.DateCreated= $("#datepicker").val();
                                    dataObject.Cost = $("#cost").val();

                                   alert(JSON.stringify(dataObject));

                            $.ajax({
                                type: "POST",
                                url: "http://localhost:1874/Rest/Operations/Create",
                                contentType: "application/json; charset=utf-8",
                                data:JSON.stringify(dataObject),
                                dataType: "json",
                                success: function(data)
                                        {
                                            alert("Doküman başarıyla oluşturuldu. ID : " + data.CreatedDocumentID);
                                        },
                                error: function () {
                                    alert("Web serviste hata oluştu.");
                                }
                            });
                        };
                }
                else{
                    alert("Lütfen doküman seçiniz.");
                }

            });


        });
       
    </script>

</head>

<!-- The dashboard content -->
<body>
    <div class="container">
      <!-- Example row of columns -->
      <div class="row">
        <div class="col-md-12">
          <h4>M-Files Doküman Test Uygulaması</h4>
          <form id="form1" role="form">
              <div class="form-group">
                <label for="email">Doküman Adı:</label>
                <input readonly type="text" class="form-control" id="documentName">
              </div>
              <div class="form-group">
                <label for="cost">Tutar:</label>
                <input required type="text" class="form-control" id="cost">
              </div>
              <div class="form-group">
                <label for="datepicker">Tarih:</label>
                <input required type="text" id="datepicker" class="form-control">
              </div>
              <div class="form-group">
                <label for="workLocations">İşyerleri:</label>
                <select class="form-control"  id="workLocations">

                </select>
              </div>
              <div class="form-group">
                <label for="employees">Personeller:</label>
                <select class="form-control"  id="employees">
                    
                </select>
              </div>
              <input type="hidden" value="" id="documentValue">
              <div class="form-group">
                <label for="document">Doküman Seçiniz:</label>
                <input type="file"  id="document">
              </div>
              <button type="button" id="createDocument" class="btn btn-default">Submit</button>
        </form>
        </div>
      
    </div> <!-- /container --> 
</body>
</html>
